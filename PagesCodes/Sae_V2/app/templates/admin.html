<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Panneau Administrateur - MySky Audio</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.0/font/bootstrap-icons.css">
    <link rel="stylesheet" href="{{ url_for('static', filename='CSS/admin.css') }}">
</head>
<body>

    <div class="header-bar">
        <div class="container py-3">
            <div class="d-flex justify-content-between align-items-center">
                <div class="d-flex align-items-center gap-3">
                    <div style="width: 48px; height: 48px; border-radius: 12px; overflow: hidden;">
                        <img src="{{ url_for('static', filename='Logo/Logo3.png') }}" alt="MySky Audio Logo" class="w-100 h-100" style="object-fit: contain;">
                    </div>
                    <div>
                        <h1 class="h5 text-white mb-0 fw-bold">MySky Audio</h1>
                        <p class="mb-0 text-white-50 small">Panneau Administrateur</p>
                    </div>
                </div>
                <a href="{{ url_for('logout') }}"><button class="btn btn-outline-light btn-sm">D√©connexion</button> </a>
            </div>
        </div>
    </div>

    <div class="container py-4">
        <!-- Titre -->
        <div class="mb-4">
            <h2 class="display-5 text-white fw-bold mb-2">Panneau Administrateur</h2>
            <p class="text-white-50 fst-italic">Gestion des appareils MySky Audio</p>
        </div>

        <!-- Section Utilisateurs -->
        <div class="users-card mb-4">
            <div class="users-header">
                <h3 class="users-title mb-0">
                    <i class="bi bi-people-fill"></i> Gestion des Utilisateurs
                </h3>

                <div class="input-group w-auto">
                    <span class="input-group-text bg-white border-end-0">
                        <i class="bi bi-search text-muted"></i>
                    </span>
                    <input type="text" id="rechercheInput" class="form-control border-start-0 ps-0" placeholder="Rechercher par email...">
                    <button class="btn btn-primary" type="button" onclick="filtreUsers()">
                        Rechercher
                    </button>
                </div>

                <button class="add-user-btn" data-bs-toggle="modal" data-bs-target="#addUserModal">
                    <i class="bi bi-plus-circle-fill"></i> Nouvel utilisateur
                </button>
            </div>

            <div class="table-responsive">
                <table class="users-table table">
                    <thead>
                        <tr>
                            <th>Pr√©nom</th>
                            <th>Nom</th>
                            <th>Email</th>
                            <th>R√¥le</th>
                            <th>Action</th>
                        </tr>
                    </thead>
                    <tbody id="usersTableBody">
                        {% for user in users %}
                        <tr class="user-row">
                            <td class="user-name-cell">{{ user.prenom }}</td>
                            <td class="user-name-cell">{{ user.nom }}</td>
                            <td class="user-email-cell">{{ user.email }}</td>
                            <td>
                                <span class="role-badge {% if user.nom_groupe == 'ADMIN' %}role-badge-admin{% elif user.nom_groupe == 'COMMERCIAL' %}role-badge-commercial{% else %}role-badge-marketing{% endif %}">
                                    {% if user.nom_groupe == 'ADMIN' %}
                                        <i class="bi bi-shield-fill-check"></i>
                                    {% elif user.nom_groupe == 'COMMERCIAL' %}
                                        <i class="bi bi-briefcase-fill"></i>
                                    {% else %}
                                        <i class="bi bi-megaphone-fill"></i>
                                    {% endif %}
                                    {{ user.nom_groupe }}
                                </span>
                            </td>
                            <td>
                                {% if user.nom_groupe != 'ADMIN' %}
                                <form method="POST" action="{{ url_for('delete_user') }}" style="display: inline;">
                                    <input type="hidden" name="email" value="{{ user.email }}">
                                    <button type="submit" class="delete-user-btn" onclick="return confirm('√ätes-vous s√ªr de vouloir supprimer {{ user.prenom }} {{ user.nom }} ?')">
                                        <i class="bi bi-trash3-fill"></i> Supprimer
                                    </button>
                                </form>
                                {% else %}
                                <span class="protected-badge">
                                    <i class="bi bi-shield-lock-fill"></i> Prot√©g√©
                                </span>
                                {% endif %}
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>

            {% if users|length > 3 %}
            <div class="text-center mt-3 mb-3">
                <button id="voirPlusBtn" class="btn btn-outline-primary btn-sm" onclick="voirPlus()">
                    <i class="bi bi-chevron-down"></i> Voir tous les utilisateurs
                </button>
            </div>
            {% endif %}

        </div>

        <!-- Boutons Services -->
       <div class="row g-3 mb-4">
    <div class="col-md-6">
        <a href="{{ url_for('marketing') }}" class="service-btn service-btn-marketing w-100 d-block text-decoration-none">
            <div class="d-flex align-items-center gap-3">
                <div class="service-icon-box">
                    <i class="bi bi-megaphone fs-2"></i>
                </div>
                <div class="flex-grow-1">
                    <h3 class="h4 mb-1 fw-bold">Service Marketing</h3>
                    <p class="mb-0 small opacity-75">Campagnes, promotions et communication</p>
                </div>
                <i class="bi bi-chevron-right fs-4 service-arrow"></i>
            </div>
        </a>
    </div>

    <div class="col-md-6">
        <a href="{{ url_for('commercial') }}" class="service-btn service-btn-commercial w-100 d-block text-decoration-none">
            <div class="d-flex align-items-center gap-3">
                <div class="service-icon-box">
                    <i class="bi bi-people fs-2"></i>
                </div>
                <div class="flex-grow-1">
                    <h3 class="h4 mb-1 fw-bold">Service Commercial</h3>
                    <p class="mb-0 small opacity-75">Ventes, clients et statistiques</p>
                </div>
                <i class="bi bi-chevron-right fs-4 service-arrow"></i>
            </div>
        </a>
    </div>
</div>

        <!-- Statistiques -->
        <div class="row g-3 mb-4">
            <div class="col-md-3">
                <div class="stat-card">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <p class="text-secondary small fw-medium mb-1">Total appareils</p>
                            <p class="h2 fw-bold mb-0" id="totalDevices">{{ devices | length }}</p>
                        </div>
                        <div class="stat-icon-box bg-primary bg-opacity-10">
                            <i class="bi bi-grid-3x3-gap fs-4 text-primary"></i>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="stat-card">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <p class="text-secondary small fw-medium mb-1">En ligne (UP)</p>
                            <p class="h2 fw-bold mb-0 text-success" id="upDevices">{{ up_devices | length }}</p>
                        </div>
                        <div class="stat-icon-box bg-success bg-opacity-10">
                            <i class="bi bi-check-circle fs-4 text-success"></i>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="stat-card">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <p class="text-secondary small fw-medium mb-1">Hors ligne (K/O)</p>
                            <p class="h2 fw-bold mb-0 text-danger" id="koDevices">{{ down_devices | length }}</p>
                        </div>
                        <div class="stat-icon-box bg-danger bg-opacity-10">
                            <i class="bi bi-x-circle fs-4 text-danger"></i>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <button onclick="syncAllKO()" class="sync-all-btn w-100 d-flex flex-column align-items-center justify-content-center gap-2">
                    <i class="bi bi-arrow-repeat fs-2"></i>
                    <span class="fw-bold small">Synchroniser tous les K/O</span>
                </button>
            </div>
        </div>

        <!-- Recherche -->
        <div class="search-card mb-4">
            <div class="row g-3">
                <div class="col-md-9">
                    <input type="text" id="searchInput" class="form-control form-control-lg" placeholder="üîç Rechercher par IP ou lieu..." onkeyup="filterDevices()">
                </div>
                <div class="col-md-3">
                    <select id="filterStatus" class="form-select form-select-lg" onchange="filterDevices()">
                        <option value="all">Tous les √©tats</option>
                        <option value="UP">UP uniquement</option>
                        <option value="KO">K/O uniquement</option>
                    </select>
                </div>
            </div>
        </div>

        <!-- Tableau Appareils -->
        <div class="table-container mb-4">
            <div class="table-scroll">
                <table class="table table-hover mb-0">
                    <thead class="sticky-top">
                        <tr>
                            <th><input type="checkbox" id="selectAll" onclick="toggleSelectAll()" class="form-check-input"></th>
                            <th>Adresse IP</th>
                            <th>Lieux</th>
                            <th>Playlist en cours</th>
                            <th>√âtat</th>
                            <th></th>
                        </tr>
                    </thead>
                    <tbody id="deviceTable"></tbody>
                    
                </table>
            </div>
        </div>

        <!-- Actions group√©es -->
        <div id="bulkActions" class="bulk-actions-card mb-4 d-none">
            <div class="d-flex justify-content-between align-items-center">
                <p class="mb-0 fw-semibold">
                    <span id="selectedCount">0</span> appareil(s) s√©lectionn√©(s)
                </p>
                <div class="d-flex gap-2">
                    <button onclick="syncSelected()" class="btn btn-primary">Synchroniser la s√©lection</button>
                    <button onclick="clearSelection()" class="btn btn-secondary">Annuler</button>
                </div>
            </div>
        </div>

        <!-- Historique -->
        <div class="history-card">
            <h3 class="h4 fw-bold mb-4">
                Historique <span class="text-secondary fw-normal">(exporter en fichier txt):</span>
            </h3>
            
            <div class="d-flex align-items-center gap-3 flex-wrap">
                <span class="fw-semibold">De</span>
                <input type="date" id="dateDebut" class="date-input">
                <span class="fw-semibold">√†</span>
                <input type="date" id="dateFin" class="date-input">
                <button onclick="exportHistory()" class="export-btn d-flex align-items-center gap-2">
                    <i class="bi bi-download"></i>
                    Exporter
                </button>
            </div>
        </div>
    </div>

    <!-- Modal Ajouter Utilisateur -->
    <div class="modal fade" id="addUserModal" tabindex="-1">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title text-white fw-bold">
                        <i class="bi bi-person-plus-fill"></i> Cr√©er un nouvel utilisateur
                    </h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <form id="addUserForm" method="POST" action="{{ url_for('signin') }}">
                <div class="modal-body">
                    <div class="mb-3">
                        <label class="form-label">
                            <i class="bi bi-person-badge"></i> Nom
                        </label>
                        <input type="text" class="form-control" id="username" name="nom" placeholder="Ex: Dupont" required>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">
                            <i class="bi bi-person"></i> Pr√©nom
                        </label>
                        <input type="text" class="form-control" id="userfirstname" name="prenom" placeholder="Ex: Jean" required>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">
                            <i class="bi bi-person"></i> Email
                        </label>
                        <input type="email" class="form-control" id="useremail" name="email" placeholder="Ex: jean.dupont@gmail.com" required>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">
                            <i class="bi bi-person"></i> Mot de passe
                        </label>
                        <input type="password" class="form-control" id="userpassword" name="mot_de_passe" required>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">
                            <i class="bi bi-award"></i> R√¥le
                        </label>
                        <select class="form-select" id="userRole" name="id_groupe" required>
                            <option value="">S√©lectionner un r√¥le...</option>
                            {% for g in groupes %}
                                <option value="{{ g[0] }}">{{ g[1] }}</option>
                            {% endfor %}
                        </select>
                    </div>
                </div>
                
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                        <i class="bi bi-x-circle"></i> Annuler
                    </button>
                    <button type="submit" class="btn btn-primary">
                        <i class="bi bi-check-circle-fill"></i> Cr√©er l'utilisateur
                    </button>
                </div>
            </form>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="{{ url_for('static', filename='JavaScript/admin.js') }}"></script>
</body>
</html>