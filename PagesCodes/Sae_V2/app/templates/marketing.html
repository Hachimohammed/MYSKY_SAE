<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Service Marketing - MySky Audio</title>
<<<<<<< HEAD
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="{{ url_for('static', filename='marketing.css') }}">
=======
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body {
            margin: 0;
            padding: 0;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #1e293b 0%, #1e3a8a 50%, #1e293b 100%);
            min-height: 100vh;
        }

        /* Header */
        .custom-header {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            border-bottom: 1px solid rgba(255, 255, 255, 0.2);
        }

        .logo-container {
            width: 48px;
            height: 48px;
            border-radius: 12px;
            overflow: hidden;
        }

        .logo-container img {
            width: 100%;
            height: 100%;
            object-fit: contain;
        }

        .header-title {
            color: white;
            font-size: 1.25rem;
            font-weight: bold;
            margin: 0;
        }

        .header-subtitle {
            color: #bfdbfe;
            font-size: 0.75rem;
            margin: 0;
        }

        .btn-logout {
            background: rgba(255, 255, 255, 0.1);
            color: white;
            border: none;
            border-radius: 8px;
            padding: 8px 16px;
            font-size: 0.875rem;
            font-weight: 500;
            transition: background 0.3s;
        }

        .btn-logout:hover {
            background: rgba(255, 255, 255, 0.2);
        }

        /* Titres principaux */
        .main-title {
            font-size: 3rem;
            font-weight: bold;
            color: white;
            text-align: center;
            margin-bottom: 0.5rem;
        }

        .main-subtitle {
            text-align: center;
            color: #bfdbfe;
            font-size: 1.125rem;
            margin-bottom: 2.5rem;
        }

        /* Carte des jours */
        .days-card {
            background: white;
            border-radius: 24px;
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
            overflow: hidden;
            max-width: 960px;
            margin: 0 auto 2rem;
        }

        .day-row {
            padding: 1.5rem 2rem;
            transition: background 0.3s;
        }

        .day-row:nth-child(even) {
            background: #f3f4f6;
        }

        .day-row:hover {
            background: #e5e7eb;
        }

        .day-row:nth-child(even):hover {
            background: #d1d5db;
        }

        .day-row:last-child {
            border-bottom-left-radius: 24px;
            border-bottom-right-radius: 24px;
        }

        .day-name {
            font-size: 1.25rem;
            font-weight: bold;
            color: #111827;
        }

        .btn-custom {
            padding: 10px 24px;
            font-weight: 600;
            border-radius: 50px;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
            border: none;
            font-size: 0.875rem;
            transition: all 0.3s;
        }

        .btn-custom:hover {
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1);
            transform: scale(1.05);
        }

        .btn-details {
            background: #3b82f6;
            color: white;
        }

        .btn-details:hover {
            background: #2563eb;
        }

        .btn-planifier {
            background: #a855f7;
            color: white;
        }

        .btn-planifier:hover {
            background: #9333ea;
        }

        .btn-add {
            background: #10b981;
            color: white;
        }

        .btn-add:hover {
            background: #059669;
        }

        .btn-delete {
            background: #ef4444;
            color: white;
        }

        .btn-delete:hover {
            background: #dc2626;
        }

        .music-badge {
            background: #f3e8ff;
            color: #7c3aed;
            padding: 8px 16px;
            border-radius: 8px;
            font-size: 0.875rem;
            font-weight: 500;
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }

        .no-music-text {
            color: #6b7280;
            font-size: 0.875rem;
            font-style: italic;
        }

        /* Boutons d'action principaux */
        .action-buttons {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 1.5rem;
            margin-top: 2.5rem;
        }

        .btn-action-main {
            padding: 16px 40px;
            font-weight: bold;
            border-radius: 16px;
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1);
            border: none;
            font-size: 1.125rem;
            display: flex;
            align-items: center;
            gap: 12px;
            transition: all 0.3s;
        }

        .btn-action-main:hover {
            box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25);
            transform: scale(1.05);
        }

        .btn-planning {
            background: linear-gradient(to right, #3b82f6, #2563eb);
            color: white;
        }

        .btn-planning:hover {
            background: linear-gradient(to right, #2563eb, #1d4ed8);
        }

        .btn-generate {
            background: linear-gradient(to right, #14b8a6, #0d9488);
            color: white;
        }

        .btn-generate:hover {
            background: linear-gradient(to right, #0d9488, #0f766e);
        }

        /* Modales */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            z-index: 1000;
            justify-content: center;
            align-items: center;
        }

        .modal.active {
            display: flex;
        }

        .modal-custom {
            background: white;
            border-radius: 24px;
            box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25);
            padding: 2rem;
            max-width: 800px;
            width: 90%;
            max-height: 80vh;
            overflow-y: auto;
        }

        .modal-custom-lg {
            max-width: 1000px;
            max-height: 90vh;
        }

        .modal-header-custom {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 1.5rem;
        }

        .modal-title-custom {
            font-size: 1.875rem;
            font-weight: bold;
            color: #111827;
        }

        .modal-close {
            background: none;
            border: none;
            color: #6b7280;
            font-size: 2rem;
            font-weight: bold;
            cursor: pointer;
            padding: 0;
            line-height: 1;
        }

        .modal-close:hover {
            color: #374151;
        }

        /* Drag and Drop */
        .fichier-item {
            cursor: move;
            transition: all 0.2s;
        }

        .fichier-item:hover {
            transform: translateX(5px);
        }

        .fichier-item.dragging {
            opacity: 0.5;
            transform: scale(0.95);
        }

        .fichier-item.drag-over {
            border-color: #8b5cf6 !important;
            background: linear-gradient(to right, #faf5ff, #f3e8ff) !important;
        }

        /* Cards personnalis√©es */
        .info-card {
            background: linear-gradient(to right, #f3e8ff, #ede9fe);
            border: 2px solid #e9d5ff;
            border-radius: 16px;
            padding: 1.5rem;
        }

        .fichier-card {
            background: linear-gradient(to right, #f3e8ff, #ede9fe);
            border: 2px solid #e9d5ff;
            border-radius: 12px;
            padding: 1.25rem;
            transition: all 0.3s;
            cursor: pointer;
        }

        .fichier-card:hover {
            border-color: #d8b4fe;
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1);
        }

        .music-icon-container {
            width: 40px;
            height: 40px;
            background: #a855f7;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
        }

        .music-icon-lg {
            width: 80px;
            height: 80px;
            background: #a855f7;
            border-radius: 16px;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1);
        }

        .date-time-section {
            background: linear-gradient(to right, #eff6ff, #dbeafe);
            border: 2px solid #bfdbfe;
            border-radius: 16px;
            padding: 1.5rem;
            margin-bottom: 1.5rem;
        }

        .info-box {
            background: white;
            border-radius: 12px;
            padding: 1.25rem;
        }

        .progress-custom {
            height: 8px;
            border-radius: 4px;
            background: #bfdbfe;
        }

        .progress-bar-custom {
            height: 100%;
            border-radius: 4px;
            background: #2563eb;
            transition: width 0.3s;
        }

        .spinner {
            animation: spin 1s linear infinite;
            width: 24px;
            height: 24px;
            border: 2px solid #bfdbfe;
            border-top-color: #2563eb;
            border-radius: 50%;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* Responsive */
        @media (max-width: 768px) {
            .main-title {
                font-size: 2rem;
            }

            .action-buttons {
                flex-direction: column;
                width: 100%;
            }

            .btn-action-main {
                width: 100%;
                justify-content: center;
            }

            .day-row {
                flex-direction: column;
                gap: 1rem;
            }
        }
    </style>
>>>>>>> e784830f0e4b72c2a804c72a4b7912a61ee737ff
</head>
<body>
    
    <!-- Header avec logo -->
    <div class="custom-header">
        <div class="container py-3">
            <div class="d-flex align-items-center justify-content-between">
                <div class="d-flex align-items-center gap-3">
                    <div class="logo-container">
                        <img 
                            src="{{ url_for('static', filename='Logo3.png') }}" 
                            alt="MySky Audio Logo"
                        />
                    </div>
                    <div>
                        <h1 class="header-title">MySky Audio</h1>
                        <p class="header-subtitle">Service Marketing - Gestion Musique d'Ambiance</p>
                    </div>
                </div>
                <a href="{{ url_for('logout') }}">
                    <button class="btn-logout">D√©connexion</button>
                </a>
            </div>
        </div>
    </div>

    <div class="container py-5">
        <!-- Titre principal -->
        <div class="mb-5">
            <h2 class="main-title">SERVICE MARKETING</h2>
            <p class="main-subtitle">Gestion de la musique d'ambiance hebdomadaire</p>
        </div>

        <!-- Liste des jours de la semaine -->
        <div class="days-card">
            {% set jours = ['LUNDI', 'MARDI', 'MERCREDI', 'JEUDI', 'VENDREDI', 'SAMEDI', 'DIMANCHE'] %}
            {% for jour in jours %}
            <div class="day-row">
                <div class="d-flex align-items-center justify-content-between mb-3 flex-wrap gap-2">
                    <span class="day-name">{{ jour }}</span>
                    <div class="d-flex align-items-center gap-2 flex-wrap">
                        {% if stats_jours.get(jour, {}).get('count', 0) > 0 %}
                        <button onclick="showDetails('{{ jour }}')" class="btn btn-custom btn-details">
                            D√©tails
                        </button>
                        
                        <button onclick="showPlanifier('{{ jour }}')" class="btn btn-custom btn-planifier">
                            Planifier
                        </button>
                        {% endif %}
                        
                        <button onclick="showUploadModal('{{ jour }}')" class="btn btn-custom btn-add">
                            Ajouter musique
                        </button>
                        {% if stats_jours.get(jour, {}).get('count', 0) > 0 %}
                        <button onclick="deleteMp3('{{ jour }}')" class="btn btn-custom btn-delete">
                            Supprimer
                        </button>
                        {% endif %}
                    </div>
                </div>
                <div class="d-flex flex-wrap gap-2 mt-2">
                    {% set count = stats_jours.get(jour, {}).get('count', 0) %}
                    {% if count > 0 %}
                    <span class="music-badge">
                        <svg width="16" height="16" fill="currentColor" viewBox="0 0 20 20">
                            <path d="M18 3a1 1 0 00-1.196-.98l-10 2A1 1 0 006 5v9.114A4.369 4.369 0 005 14c-1.657 0-3 .895-3 2s1.343 2 3 2 3-.895 3-2V7.82l8-1.6v5.894A4.37 4.37 0 0015 12c-1.657 0-3 .895-3 2s1.343 2 3 2 3-.895 3-2V3z"/>
                        </svg>
                        {{ count }} musique{{ 's' if count > 1 else '' }}
                    </span>
                    {% else %}
                    <p class="no-music-text mb-0">Aucune musique programm√©e</p>
                    {% endif %}
                </div>
            </div>
            {% endfor %}
        </div>

        <!-- Boutons d'action principaux -->
        <div class="action-buttons">
            <button onclick="showPlanning()" class="btn btn-action-main btn-planning">
                <svg width="24" height="24" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"/>
                </svg>
                Voir planning musical
            </button>
            <button onclick="generatePlaylist()" class="btn btn-action-main btn-generate">
                <svg width="24" height="24" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19V6l12-3v13M9 19c0 1.105-1.343 2-3 2s-3-.895-3-2 1.343-2 3-2 3 .895 3 2zm12-3c0 1.105-1.343 2-3 2s-3-.895-3-2 1.343-2 3-2 3 .895 3 2zM9 10l12-3"/>
                </svg>
                G√©n√©rer playlist
            </button>
        </div>
    </div>

    <!-- Modal Upload -->
    <div id="uploadModal" class="modal">
        <div class="modal-custom">
            <div class="modal-header-custom">
                <h3 class="modal-title-custom" id="uploadModalTitle">Ajouter des musiques</h3>
                <button onclick="closeUploadModal()" class="modal-close">√ó</button>
            </div>

            <form id="uploadForm" enctype="multipart/form-data">
                <input type="hidden" id="jour_upload" name="jour_semaine">
                
                <div class="mb-4">
                    <label class="form-label fw-semibold">S√©lectionner des fichiers MP3</label>
                    <input 
                        type="file" 
                        id="fileInput" 
                        name="files[]"
                        accept=".mp3,audio/mpeg"
                        multiple
                        class="form-control"
                    >
                    <small class="text-muted">Vous pouvez s√©lectionner plusieurs fichiers MP3</small>
                </div>

                <div id="uploadProgress" class="mb-4" style="display: none;">
                    <div class="p-3 rounded" style="background: #dbeafe;">
                        <div class="d-flex align-items-center gap-3 mb-2">
                            <div class="spinner"></div>
                            <span class="fw-semibold" style="color: #1d4ed8;">Upload en cours...</span>
                        </div>
                        <div class="progress-custom">
                            <div id="progressBar" class="progress-bar-custom" style="width: 0%"></div>
                        </div>
                    </div>
                </div>

                <div class="d-flex gap-2">
                    <button type="button" onclick="uploadFiles()" class="btn btn-primary flex-fill fw-bold">
                        T√©l√©charger
                    </button>
                    <button type="button" onclick="closeUploadModal()" class="btn btn-secondary">
                        Annuler
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Modal D√©tails des MP3 -->
    <div id="detailsModal" class="modal">
        <div class="modal-custom">
            <div class="modal-header-custom">
                <h3 class="modal-title-custom" id="modalTitle">D√©tails</h3>
                <button onclick="closeModal()" class="modal-close">√ó</button>
            </div>

            <p class="text-muted mb-4" id="modalDescription"></p>

            <div id="mp3List" class="mb-4"></div>

            <div class="text-end">
                <button onclick="closeModal()" class="btn btn-secondary">Fermer</button>
            </div>
        </div>
    </div>

    <!-- Modal Planifier avec Date/Heure -->
    <div id="planifierModal" class="modal">
        <div class="modal-custom modal-custom-lg">
            <div class="modal-header-custom">
                <div>
                    <h3 class="modal-title-custom">üìã Planifier l'ordre</h3>
                    <p class="text-muted mb-0" id="planifierJour"></p>
                </div>
                <button onclick="closePlanifierModal()" class="modal-close">√ó</button>
            </div>

            <!-- Formulaire de date/heure de diffusion -->
            <div class="date-time-section">
                <h4 class="h5 fw-bold mb-3 d-flex align-items-center gap-2">
                    <svg width="20" height="20" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"/>
                    </svg>
                    Date et heure de diffusion
                </h4>
                <div class="row g-3">
                    <div class="col-md-6">
                        <label class="form-label fw-semibold">Date de diffusion</label>
                        <input 
                            type="date" 
                            id="dateDiffusion"
                            class="form-control"
                        />
                    </div>
                    <div class="col-md-6">
                        <label class="form-label fw-semibold">Heure de diffusion</label>
                        <input 
                            type="time" 
                            id="heureDiffusion"
                            class="form-control"
                        />
                    </div>
                </div>
                <p class="small mt-3 mb-0 d-flex align-items-center gap-2" style="color: #1d4ed8;">
                    <svg width="16" height="16" fill="currentColor" viewBox="0 0 20 20">
                        <path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7-4a1 1 0 11-2 0 1 1 0 012 0zM9 9a1 1 0 000 2v3a1 1 0 001 1h1a1 1 0 100-2v-3a1 1 0 00-1-1H9z" clip-rule="evenodd"/>
                    </svg>
                    D√©finissez la date et l'heure de d√©but de diffusion de cette playlist
                </p>
            </div>

            <div class="info-card mb-4">
                <p class="mb-0 fw-semibold d-flex align-items-center gap-2" style="color: #581c87;">
                    <svg width="20" height="20" fill="currentColor" viewBox="0 0 20 20">
                        <path d="M10 18a8 8 0 100-16 8 8 0 000 16zM9.555 7.168A1 1 0 008 8v4a1 1 0 001.555.832l3-2a1 1 0 000-1.664l-3-2z"/>
                    </svg>
                    Glissez-d√©posez les fichiers pour d√©finir l'ordre de lecture
                </p>
            </div>

            <div id="fichiersOrdreListe" class="mb-4"></div>

            <div class="d-flex gap-2 pt-3 border-top">
                <button onclick="savePlanification()" class="btn btn-success flex-fill fw-bold d-flex align-items-center justify-content-center gap-2">
                    <svg width="20" height="20" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"/>
                    </svg>
                    Sauvegarder la planification
                </button>
                <button onclick="closePlanifierModal()" class="btn btn-secondary">Annuler</button>
            </div>
        </div>
    </div>

<<<<<<< HEAD
    <script src="{{ url_for('static', filename='marketing.js') }}"></script>
=======
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        const API_BASE = window.location.origin;
        let currentPlanifierJour = '';
        let fichiersOrdre = [];
        let draggedElement = null;

        function showUploadModal(jour) {
            document.getElementById('uploadModalTitle').textContent = `Ajouter des musiques - ${jour}`;
            document.getElementById('jour_upload').value = jour;
            document.getElementById('fileInput').value = '';
            document.getElementById('uploadProgress').style.display = 'none';
            document.getElementById('uploadModal').classList.add('active');
        }

        function closeUploadModal() {
            document.getElementById('uploadModal').classList.remove('active');
        }

        async function uploadFiles() {
            const fileInput = document.getElementById('fileInput');
            const jour = document.getElementById('jour_upload').value;
            const files = fileInput.files;

            if (files.length === 0) {
                alert('Veuillez s√©lectionner au moins un fichier MP3');
                return;
            }

            const formData = new FormData();
            formData.append('jour_semaine', jour);
            
            for (let file of files) {
                formData.append('files[]', file);
            }

            document.getElementById('uploadProgress').style.display = 'block';
            document.getElementById('progressBar').style.width = '50%';

            try {
                const response = await fetch(`${API_BASE}/marketing/upload/multiple`, {
                    method: 'POST',
                    body: formData
                });

                const data = await response.json();
                document.getElementById('progressBar').style.width = '100%';

                if (data.success) {
                    alert(`${data.uploaded} fichier(s) t√©l√©charg√©(s) avec succ√®s!`);
                    if (data.errors && data.errors.length > 0) {
                        console.log('Erreurs:', data.errors);
                    }
                    closeUploadModal();
                    location.reload();
                } else {
                    alert('Erreur lors du t√©l√©chargement: ' + data.error);
                }
            } catch (error) {
                console.error('Erreur:', error);
                alert('Erreur lors du t√©l√©chargement des fichiers');
            } finally {
                document.getElementById('uploadProgress').style.display = 'none';
            }
        }

        async function showDetails(jour) {
            const modal = document.getElementById('detailsModal');
            const modalTitle = document.getElementById('modalTitle');
            const modalDescription = document.getElementById('modalDescription');
            const mp3List = document.getElementById('mp3List');
            
            modalTitle.textContent = `D√©tails - ${jour}`;
            modalDescription.textContent = 'Chargement...';
            mp3List.innerHTML = '';
            modal.classList.add('active');

            try {
                const response = await fetch(`${API_BASE}/api/v1/audio/list?jour=${jour}`);
                const data = await response.json();

                if (data.success && data.data.length > 0) {
                    modalDescription.textContent = 'Cliquez sur une musique pour voir ses informations d√©taill√©es :';
                    
                    mp3List.innerHTML = data.data.map((fichier, index) => `
                        <div onclick='showMp3Details(${JSON.stringify(fichier).replace(/'/g, "&apos;")})' class="fichier-card mb-3">
                            <div class="d-flex align-items-center justify-content-between gap-3">
                                <div class="d-flex align-items-center gap-3 flex-fill">
                                    <div class="music-icon-container">
                                        <svg width="20" height="20" fill="white" viewBox="0 0 20 20">
                                            <path d="M18 3a1 1 0 00-1.196-.98l-10 2A1 1 0 006 5v9.114A4.369 4.369 0 005 14c-1.657 0-3 .895-3 2s1.343 2 3 2 3-.895 3-2V7.82l8-1.6v5.894A4.37 4.37 0 0015 12c-1.657 0-3 .895-3 2s1.343 2 3 2 3-.895 3-2V3z"/>
                                        </svg>
                                    </div>
                                    <div>
                                        <h4 class="h6 fw-bold mb-0">${fichier.nom}</h4>
                                        <p class="small text-muted mb-0">${fichier.artiste || 'Inconnu'}</p>
                                    </div>
                                </div>
                                <svg width="20" height="20" fill="none" stroke="#a855f7" viewBox="0 0 24 24"><svg width="20" height="20" fill="none" stroke="#a855f7" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"/>
                                </svg>
                            </div>
                        </div>
                    `).join('');
                } else {
                    modalDescription.textContent = '';
                    mp3List.innerHTML = '<p class="text-muted fst-italic">Aucune musique disponible pour ce jour</p>';
                }
            } catch (error) {
                console.error('Erreur:', error);
                modalDescription.textContent = '';
                mp3List.innerHTML = '<p class="text-danger">Erreur lors du chargement des donn√©es</p>';
            }
        }

        function showMp3Details(fichier) {
            const modalTitle = document.getElementById('modalTitle');
            const modalDescription = document.getElementById('modalDescription');
            const mp3List = document.getElementById('mp3List');
            
            modalTitle.textContent = `Informations - ${fichier.nom}`;
            modalDescription.textContent = '';
            
            const dureeMin = Math.floor(fichier.duree / 60);
            const dureeSec = fichier.duree % 60;
            const tailleMB = (fichier.taille / (1024 * 1024)).toFixed(2);
            
            mp3List.innerHTML = `
                <div class="p-4 rounded-3" style="background: linear-gradient(to right, #f3e8ff, #ede9fe); border: 2px solid #e9d5ff;">
                    <div class="d-flex align-items-start gap-4 mb-4">
                        <div class="music-icon-lg flex-shrink-0">
                            <svg width="40" height="40" fill="white" viewBox="0 0 20 20">
                                <path d="M18 3a1 1 0 00-1.196-.98l-10 2A1 1 0 006 5v9.114A4.369 4.369 0 005 14c-1.657 0-3 .895-3 2s1.343 2 3 2 3-.895 3-2V7.82l8-1.6v5.894A4.37 4.37 0 0015 12c-1.657 0-3 .895-3 2s1.343 2 3 2 3-.895 3-2V3z"/>
                            </svg>
                        </div>
                        <div class="flex-fill">
                            <h4 class="h4 fw-bold mb-2">${fichier.nom}</h4>
                            <p class="mb-3 text-secondary">${fichier.artiste || 'Artiste inconnu'}</p>
                            <span class="badge" style="background: #e9d5ff; color: #6b21a8; font-size: 0.875rem; padding: 0.5rem 0.75rem;">
                                ${fichier.album || 'Album inconnu'}
                            </span>
                        </div>
                    </div>
                    
                    <div class="info-box">
                        <div class="row g-3">
                            <div class="col-6">
                                <div class="text-muted small fw-medium mb-1">Type</div>
                                <div class="fw-bold h5 mb-0">${fichier.type_fichier.toUpperCase()}</div>
                            </div>
                            <div class="col-6">
                                <div class="text-muted small fw-medium mb-1">Dur√©e</div>
                                <div class="fw-bold h5 mb-0">${dureeMin}:${dureeSec.toString().padStart(2, '0')}</div>
                            </div>
                            <div class="col-6">
                                <div class="text-muted small fw-medium mb-1">Taille</div>
                                <div class="fw-bold h5 mb-0">${tailleMB} MB</div>
                            </div>
                            <div class="col-6">
                                <div class="text-muted small fw-medium mb-1">Date d'ajout</div>
                                <div class="fw-bold h5 mb-0">${new Date(fichier.date_ajout).toLocaleDateString('fr-FR')}</div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="d-flex gap-2 mt-4">
                        <a href="${fichier.download_url}" class="btn btn-success flex-fill fw-bold">
                            T√©l√©charger
                        </a>
                        <button onclick="confirmDeleteMp3(${fichier.id_fichier}, '${fichier.nom}')" class="btn btn-danger fw-bold">
                            Supprimer
                        </button>
                    </div>
                </div>
            `;
        }

        async function confirmDeleteMp3(id, nom) {
            if (!confirm(`√ätes-vous s√ªr de vouloir supprimer "${nom}" ?`)) {
                return;
            }

            try {
                const response = await fetch(`${API_BASE}/marketing/musique/${id}`, {
                    method: 'DELETE'
                });
                const data = await response.json();

                if (data.success) {
                    alert('Musique supprim√©e avec succ√®s');
                    closeModal();
                    location.reload();
                } else {
                    alert('Erreur lors de la suppression: ' + data.error);
                }
            } catch (error) {
                console.error('Erreur:', error);
                alert('Erreur lors de la suppression');
            }
        }

        async function deleteMp3(jour) {
            if (!confirm(`√ätes-vous s√ªr de vouloir supprimer TOUTES les musiques de ${jour} ?`)) {
                return;
            }

            try {
                const response = await fetch(`${API_BASE}/marketing/jour/${jour}/delete`, {
                    method: 'DELETE'
                });
                const data = await response.json();

                if (data.success) {
                    alert(`${data.count} musique(s) supprim√©e(s) avec succ√®s`);
                    location.reload();
                } else {
                    alert('Erreur lors de la suppression: ' + data.error);
                }
            } catch (error) {
                console.error('Erreur:', error);
                alert('Erreur lors de la suppression');
            }
        }

        function closeModal() {
            document.getElementById('detailsModal').classList.remove('active');
        }

        async function showPlanifier(jour) {
            currentPlanifierJour = jour;
            document.getElementById('planifierJour').textContent = `Organisez l'ordre de lecture pour ${jour}`;
            
            document.getElementById('dateDiffusion').value = '';
            document.getElementById('heureDiffusion').value = '';
            
            try {
                const response = await fetch(`${API_BASE}/marketing/jour/${jour}/fichiers-ordre`);
                const data = await response.json();
                
                if (data.success) {
                    fichiersOrdre = data.fichiers;
                    renderFichiersOrdre();
                    document.getElementById('planifierModal').classList.add('active');
                } else {
                    alert('Erreur: ' + data.error);
                }
            } catch (error) {
                console.error('Erreur:', error);
                alert('Erreur lors du chargement des fichiers');
            }
        }

        function closePlanifierModal() {
            document.getElementById('planifierModal').classList.remove('active');
        }

        function renderFichiersOrdre() {
            const container = document.getElementById('fichiersOrdreListe');
            
            if (fichiersOrdre.length === 0) {
                container.innerHTML = '<p class="text-muted fst-italic text-center py-4">Aucun fichier disponible</p>';
                return;
            }
            
            container.innerHTML = fichiersOrdre.map((fichier, index) => `
                <div 
                    class="fichier-item fichier-card mb-3"
                    draggable="true"
                    data-id="${fichier.id}"
                    data-index="${index}"
                    ondragstart="handleDragStart(event)"
                    ondragover="handleDragOver(event)"
                    ondrop="handleDrop(event)"
                    ondragend="handleDragEnd(event)"
                    ondragenter="handleDragEnter(event)"
                    ondragleave="handleDragLeave(event)"
                >
                    <div class="d-flex align-items-center gap-3">
                        <div class="flex-shrink-0">
                            <div class="d-flex align-items-center justify-content-center" style="width: 48px; height: 48px; background: #a855f7; border-radius: 12px; box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);">
                                <span class="text-white h5 fw-bold mb-0">${index + 1}</span>
                            </div>
                        </div>
                        
                        <div class="flex-shrink-0" style="color: #c084fc;">
                            <svg width="24" height="24" fill="currentColor" viewBox="0 0 20 20">
                                <path d="M10 6a2 2 0 110-4 2 2 0 010 4zM10 12a2 2 0 110-4 2 2 0 010 4zM10 18a2 2 0 110-4 2 2 0 010 4z"/>
                            </svg>
                        </div>
                        
                        <div class="flex-fill">
                            <h4 class="h6 fw-bold mb-0">${fichier.nom}</h4>
                            <p class="small text-muted mb-0">${fichier.artiste} ‚Ä¢ ${fichier.duree_formattee}</p>
                        </div>
                        
                        <div class="d-flex gap-2">
                            <button 
                                onclick="moveUp(${index}); event.stopPropagation();" 
                                class="btn btn-primary btn-sm d-flex align-items-center justify-content-center"
                                style="width: 40px; height: 40px; border-radius: 8px;"
                                ${index === 0 ? 'disabled style="opacity: 0.3; cursor: not-allowed;"' : ''}
                            >
                                <svg width="20" height="20" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 15l7-7 7 7"/>
                                </svg>
                            </button>
                            <button 
                                onclick="moveDown(${index}); event.stopPropagation();" 
                                class="btn btn-primary btn-sm d-flex align-items-center justify-content-center"
                                style="width: 40px; height: 40px; border-radius: 8px;"
                                ${index === fichiersOrdre.length - 1 ? 'disabled style="opacity: 0.3; cursor: not-allowed;"' : ''}
                            >
                                <svg width="20" height="20" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"/>
                                </svg>
                            </button>
                        </div>
                    </div>
                </div>
            `).join('');
        }

        function moveUp(index) {
            if (index > 0) {
                const temp = fichiersOrdre[index];
                fichiersOrdre[index] = fichiersOrdre[index - 1];
                fichiersOrdre[index - 1] = temp;
                renderFichiersOrdre();
            }
        }

        function moveDown(index) {
            if (index < fichiersOrdre.length - 1) {
                const temp = fichiersOrdre[index];
                fichiersOrdre[index] = fichiersOrdre[index + 1];
                fichiersOrdre[index + 1] = temp;
                renderFichiersOrdre();
            }
        }

        function handleDragStart(e) {
            draggedElement = e.target;
            e.target.classList.add('dragging');
            e.dataTransfer.effectAllowed = 'move';
            e.dataTransfer.setData('text/html', e.target.innerHTML);
        }

        function handleDragOver(e) {
            if (e.preventDefault) {
                e.preventDefault();
            }
            e.dataTransfer.dropEffect = 'move';
            return false;
        }

        function handleDragEnter(e) {
            if (e.target.classList.contains('fichier-item') && e.target !== draggedElement) {
                e.target.classList.add('drag-over');
            }
        }

        function handleDragLeave(e) {
            if (e.target.classList.contains('fichier-item')) {
                e.target.classList.remove('drag-over');
            }
        }

        function handleDrop(e) {
            if (e.stopPropagation) {
                e.stopPropagation();
            }
            
            if (draggedElement !== e.target && e.target.classList.contains('fichier-item')) {
                const draggedIndex = parseInt(draggedElement.getAttribute('data-index'));
                const targetIndex = parseInt(e.target.getAttribute('data-index'));
                
                const draggedItem = fichiersOrdre[draggedIndex];
                fichiersOrdre.splice(draggedIndex, 1);
                fichiersOrdre.splice(targetIndex, 0, draggedItem);
                
                renderFichiersOrdre();
            }
            
            return false;
        }

        function handleDragEnd(e) {
            e.target.classList.remove('dragging');
            document.querySelectorAll('.fichier-item').forEach(item => {
                item.classList.remove('drag-over');
            });
        }

        async function savePlanification() {
            if (fichiersOrdre.length === 0) {
                alert('Aucun fichier √† sauvegarder');
                return;
            }
            
            const dateDiffusion = document.getElementById('dateDiffusion').value;
            const heureDiffusion = document.getElementById('heureDiffusion').value;
            
            if (!dateDiffusion || !heureDiffusion) {
                alert('‚ö†Ô∏è Veuillez saisir la date et l\'heure de diffusion');
                return;
            }
            
            const datetimeDiffusion = `${dateDiffusion} ${heureDiffusion}`;
            
            if (!confirm(`‚úÖ Sauvegarder l'ordre de lecture pour ${currentPlanifierJour} ?\n\n${fichiersOrdre.length} fichiers seront ordonn√©s.\nüìÖ Date de diffusion: ${dateDiffusion}\nüïê Heure de diffusion: ${heureDiffusion}\n\nVous devrez ensuite cliquer sur "G√©n√©rer playlist" pour cr√©er les fichiers M3U.`)) {
                return;
            }
            
            try {
                const fichiersIds = fichiersOrdre.map(f => f.id);
                
                const response = await fetch(`${API_BASE}/marketing/jour/${currentPlanifierJour}/sauvegarder-ordre`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        fichiers_ordre: fichiersIds,
                        date_diffusion: dateDiffusion,
                        heure_diffusion: heureDiffusion,
                        datetime_diffusion: datetimeDiffusion
                    })
                });
                
                const data = await response.json();
                
                if (data.success) {
                    alert(`‚úÖ Ordre sauvegard√© pour ${currentPlanifierJour} !\n\nüìù ${fichiersOrdre.length} fichiers ordonn√©s\nüìÖ Diffusion pr√©vue le ${dateDiffusion} √† ${heureDiffusion}\n\nüí° Pour cr√©er la playlist M3U, cliquez maintenant sur le bouton "G√©n√©rer playlist" en bas de la page.`);
                    closePlanifierModal();
                } else {
                    alert('‚ùå Erreur: ' + data.error);
                }
            } catch (error) {
                console.error('Erreur:', error);
                alert('‚ùå Erreur lors de la sauvegarde');
            }
        }

        document.getElementById('detailsModal').addEventListener('click', function(e) {
            if (e.target === this) {
                closeModal();
            }
        });

    async function showPlanning() {
    const modal = document.getElementById('detailsModal');
    const modalTitle = document.getElementById('modalTitle');
    const modalDescription = document.getElementById('modalDescription');
    const mp3List = document.getElementById('mp3List');
    
    modalTitle.textContent = 'Statistiques de la semaine';
    modalDescription.textContent = 'Chargement...';
    mp3List.innerHTML = '';
    modal.classList.add('active');

    try {
        const response = await fetch(`${API_BASE}/marketing/stats/semaine`);
        const data = await response.json();

        if (data.success) {
            modalDescription.textContent = 'Aper√ßu des musiques par jour :';
            
            const jours = ['LUNDI', 'MARDI', 'MERCREDI', 'JEUDI', 'VENDREDI', 'SAMEDI', 'DIMANCHE'];
            const couleurs = ['primary', 'info', 'purple', 'pink', 'danger', 'warning', 'success'];
            
            mp3List.innerHTML = `
                <div class="row g-3">
                    ${jours.map((jour, idx) => {
                        // LE PROBL√àME √âTAIT ICI : la cl√© est 'count' pas 'nombre_musiques'
                        const stats = data.data.par_jour[jour] || { count: 0, duree_totale: 0 };
                        const nombreMusiques = stats.count || 0;  // 'count' au lieu de 'nombre_musiques'
                        const dureeTotale = stats.duree_totale || 0;
                        
                        const bgColor = idx === 2 ? 'linear-gradient(135deg, #f3e8ff, #ede9fe)' : 
                                      idx === 3 ? 'linear-gradient(135deg, #fce7f3, #fbcfe8)' :
                                      `var(--bs-${couleurs[idx]}-bg-subtle)`;
                        return `
                            <div class="col-md-6">
                                <div onclick="showDetails('${jour}')" class="p-4 rounded-3 border-2 h-100" style="background: ${bgColor}; border: 2px solid var(--bs-${couleurs[idx]}-border-subtle); cursor: pointer; transition: all 0.3s;" onmouseover="this.style.transform='scale(1.05)'; this.style.boxShadow='0 10px 15px -3px rgba(0,0,0,0.1)';" onmouseout="this.style.transform=''; this.style.boxShadow='';">
                                    <div class="d-flex align-items-center justify-content-between mb-3">
                                        <h4 class="h5 fw-bold mb-0">${jour}</h4>
                                        <svg width="24" height="24" fill="none" stroke="var(--bs-${couleurs[idx]})" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"/>
                                        </svg>
                                    </div>
                                    <div class="d-flex flex-column gap-2">
                                        <div class="d-flex align-items-center gap-2">
                                            <svg width="20" height="20" fill="var(--bs-${couleurs[idx]})" viewBox="0 0 20 20">
                                                <path d="M18 3a1 1 0 00-1.196-.98l-10 2A1 1 0 006 5v9.114A4.369 4.369 0 005 14c-1.657 0-3 .895-3 2s1.343 2 3 2 3-.895 3-2V7.82l8-1.6v5.894A4.37 4.37 0 0015 12c-1.657 0-3 .895-3 2s1.343 2 3 2 3-.895 3-2V3z"/>
                                            </svg>
                                            <span class="fw-semibold">${nombreMusiques} musique${nombreMusiques !== 1 ? 's' : ''}</span>
                                        </div>
                                        <div class="small text-muted">Dur√©e: ${Math.floor(dureeTotale / 60)}min</div>
                                    </div>
                                </div>
                            </div>
                        `;
                    }).join('')}
                </div>
                <div class="mt-4 p-4 rounded-3" style="background: linear-gradient(to right, #f0fdfa, #ccfbf1); border: 2px solid #99f6e4;">
                    <h4 class="h5 fw-bold mb-3">Total de la semaine</h4>
                    <div class="row g-3">
                        <div class="col-4">
                            <div class="display-6 fw-bold text-primary">${data.data.totaux.nombre_musiques || 0}</div>
                            <div class="small text-muted">Musiques</div>
                        </div>
                        <div class="col-4">
                            <div class="display-6 fw-bold text-primary">${Math.floor((data.data.totaux.duree_totale || 0) / 60)}</div>
                            <div class="small text-muted">Minutes</div>
                        </div>
                        <div class="col-4">
                            <div class="display-6 fw-bold text-primary">${((data.data.totaux.taille_totale || 0) / (1024 * 1024)).toFixed(1)}</div>
                            <div class="small text-muted">MB</div>
                        </div>
                    </div>
                </div>
            `;
        }
    } catch (error) {
        console.error('Erreur:', error);
        modalDescription.textContent = '';
        mp3List.innerHTML = '<p class="text-danger">Erreur lors du chargement des statistiques</p>';
    }
}
    async function generatePlaylist() {
        if (!confirm('G√©n√©rer les playlists pour toute la semaine ?')) {
            return;
        }

        try {
            const response = await fetch(`${API_BASE}/marketing/playlist/generate/week`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                }
            });
            
            const data = await response.json();

            if (data.success) {
                alert(`${data.count} playlist(s) g√©n√©r√©e(s) avec succ√®s!`);
                showPlaylistsGenerated(data.data);
            } else {
                alert('Erreur lors de la g√©n√©ration: ' + data.error);
            }
        } catch (error) {
            console.error('Erreur:', error);
            alert('Erreur lors de la g√©n√©ration des playlists');
        }
    }

        function showPlaylistsGenerated(playlists) {
            const modal = document.getElementById('detailsModal');
            const modalTitle = document.getElementById('modalTitle');
            const modalDescription = document.getElementById('modalDescription');
            const mp3List = document.getElementById('mp3List');
            
            modalTitle.textContent = 'Playlists g√©n√©r√©es';
            modalDescription.textContent = `${playlists.length} playlist(s) M3U cr√©√©e(s) avec succ√®s :`;
            
            mp3List.innerHTML = `
                <div class="d-flex flex-column gap-3">
                    ${playlists.map(playlist => {
                        const dureeMin = Math.floor(playlist.duree_total / 60);
                        return `
                            <div class="p-4 rounded-3" style="background: linear-gradient(to right, #f0fdfa, #ccfbf1); border: 2px solid #99f6e4;">
                                <div class="d-flex align-items-center justify-content-between">
                                    <div class="d-flex align-items-center gap-3">
                                        <div class="d-flex align-items-center justify-content-center" style="width: 48px; height: 48px; background: #14b8a6; border-radius: 12px;">
                                            <svg width="24" height="24" fill="none" stroke="white" viewBox="0 0 24 24">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19V6l12-3v13M9 19c0 1.105-1.343 2-3 2s-3-.895-3-2 1.343-2 3-2 3 .895 3 2zm12-3c0 1.105-1.343 2-3 2s-3-.895-3-2 1.343-2 3-2 3 .895 3 2zM9 10l12-3"/>
                                            </svg>
                                        </div>
                                        <div>
                                            <h4 class="h6 fw-bold mb-0">${playlist.nom_playlist}</h4>
                                            <p class="small text-muted mb-0">Dur√©e: ${dureeMin} minutes</p>
                                        </div>
                                    </div>
                                    <a href="${API_BASE}/api/v1/playlist/download/${playlist.id_playlist}" class="btn btn-success">
                                        T√©l√©charger M3U
                                    </a>
                                </div>
                            </div>
                        `;
                    }).join('')}
                </div>
                <div class="mt-4 text-center">
                    <p class="text-muted mb-3">Les fichiers M3U sont pr√™ts √† √™tre d√©ploy√©s sur les lecteurs</p>
                    <button onclick="closeModal()" class="btn btn-secondary">Fermer</button>
                </div>
            `;
            
            modal.classList.add('active');
        }

        document.getElementById('uploadModal').addEventListener('click', function(e) {
            if (e.target === this) {
                closeUploadModal();
            }
        });

        document.getElementById('planifierModal').addEventListener('click', function(e) {
            if (e.target === this) {
                closePlanifierModal();
            }
        });
    </script>
>>>>>>> e784830f0e4b72c2a804c72a4b7912a61ee737ff
</body>
</html>